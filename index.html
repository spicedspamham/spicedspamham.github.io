<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Feeling Hypomanic</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <style>
    :root {
      --bg: #0a0e17;
      --panel: rgba(20, 25, 45, 0.9);
      --text: #e0f7ff;
      --muted: #88ccff;
      --accent1: #00f0ff;
      --accent2: #ff00aa;
      --accent-border: rgba(0,240,255,0.25);
      --glow: 0 0 15px rgba(0, 240, 255, 0.8);
      --ad-color: rgba(255, 255, 0, 0.1);
    }

    * { box-sizing: border-box; }

    body {
      font-family: 'Segoe UI', system-ui, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      overflow-x: hidden;
      position: relative;
      transition: background 0.3s ease, color 0.3s ease;
      font-weight: 500;
      margin: 0;
      padding: 0;
    }

    #particles {
      position: fixed; top:0; left:0; width:100%; height:100%; z-index:-2; pointer-events:none;
    }

    .scanlines {
      position: fixed; inset:0; pointer-events:none; z-index:-1;
      background: repeating-linear-gradient(transparent 0px, transparent 2px, rgba(0,240,255,0.03) 2px, rgba(0,240,255,0.03) 4px);
      opacity: 0.6;
    }

    .container { max-width: 900px; margin: 0 auto; padding: 20px 15px; position: relative; z-index:1; }

    header { text-align: center; padding: 40px 0 20px; }
    h1 {
      font-size: 3.8rem;
      background: linear-gradient(90deg, var(--accent1), var(--accent2), var(--accent1));
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
      text-shadow: var(--glow);
      letter-spacing: 4px;
      margin: 0;
    }

    .tagline { color: var(--muted); font-size: 1.2rem; opacity: 0.9; letter-spacing: 1px; margin-top: 10px; }

    .panel {
      background: var(--panel);
      backdrop-filter: blur(12px);
      border: 1px solid var(--accent-border);
      border-radius: 18px;
      padding: 24px;
      margin: 24px 0;
      box-shadow: 0 10px 40px rgba(0,0,0,0.6), inset 0 0 25px rgba(255,255,255,0.05);
      transition: all 0.3s ease;
    }

    .panel:hover { border-color: var(--accent1); }

    .ad-panel {
      background: var(--ad-color);
      backdrop-filter: blur(12px);
      border: 2px dashed rgba(255, 255, 0, 0.4);
      border-radius: 12px;
      padding: 16px;
      margin: 24px 0;
      text-align: center;
      position: relative;
    }

    .ad-badge {
      position: absolute;
      top: -10px;
      left: 10px;
      background: rgba(255, 255, 0, 0.8);
      color: #000;
      padding: 4px 12px;
      border-radius: 4px;
      font-size: 0.75rem;
      font-weight: bold;
      letter-spacing: 2px;
    }

    .ad-close {
      position: absolute;
      top: 8px;
      right: 8px;
      background: rgba(255, 0, 0, 0.8);
      color: white;
      border: none;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      cursor: pointer;
      font-weight: bold;
      font-size: 0.9rem;
      line-height: 1;
      padding: 0;
      margin: 0;
    }

    .travel-badge {
      background: linear-gradient(135deg, #ff6b6b, #ee5a6f);
      color: white;
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 0.75rem;
      font-weight: bold;
      margin-left: 8px;
    }

    textarea, input[type="text"], input[type="color"], input[type="search"], input[type="number"] {
      width: 100%; padding: 14px 16px; border: 1px solid var(--accent-border);
      border-radius: 12px; background: rgba(10, 20, 40, 0.95) !important; color: white !important;
      font-size: 1.05rem; transition: all 0.3s;
    }

    textarea { min-height: 120px; resize: vertical; }

    textarea:focus, input:focus {
      outline: none; border-color: var(--accent1); box-shadow: var(--glow);
      background: rgba(10, 30, 60, 0.95) !important;
    }

    .format-toolbar {
      display: flex;
      gap: 8px;
      margin-bottom: 12px;
      flex-wrap: wrap;
      align-items: center;
    }

    .format-btn {
      background: rgba(0, 240, 255, 0.1);
      border: 1px solid var(--accent-border);
      color: var(--text) !important;
      padding: 8px 12px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.9rem;
      transition: all 0.2s;
    }

    .format-btn:hover {
      background: rgba(0, 240, 255, 0.2);
      border-color: var(--accent1);
    }

    button {
      background: linear-gradient(135deg, var(--accent1), var(--accent2));
      border: none; color: white !important; padding: 14px 28px;
      border-radius: 12px; font-weight: bold; cursor: pointer;
      transition: all 0.3s; box-shadow: 0 6px 20px rgba(0,0,0,0.5);
      margin-top: 10px;
    }

    button:hover { transform: translateY(-3px); box-shadow: 0 12px 30px rgba(255,255,255,0.15); }

    .tabs { display: flex; gap: 16px; margin: 24px 0 16px; justify-content: center; flex-wrap: wrap; }
    .tab-btn { 
      background: none; border: none; color: var(--muted) !important; cursor: pointer; 
      font-size: 1.1rem; padding: 8px 16px; transition: all 0.3s; 
    }
    .tab-btn.active { color: var(--accent1) !important; text-shadow: var(--glow); border-bottom: 2px solid var(--accent1); }

    .filters { 
      display: flex; gap: 12px; justify-content: center; margin: 16px 0; 
      flex-wrap: wrap; align-items: center;
    }
    .filter-btn {
      background: var(--panel); border: 1px solid var(--accent-border); 
      padding: 8px 16px; border-radius: 8px; cursor: pointer; transition: all 0.3s;
      font-size: 0.95rem; color: var(--text) !important;
    }
    .filter-btn.active { border-color: var(--accent1); background: rgba(0, 240, 255, 0.1); }
    .filter-btn:hover { border-color: var(--accent1); }

    .search-box {
      margin: 16px 0;
      display: flex;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
    }

    .search-box input {
      flex: 1;
      margin: 0;
      min-width: 200px;
    }

    .post {
      background: rgba(15, 25, 50, 0.6);
      border: 1px solid var(--accent-border);
      border-radius: 16px; padding: 18px; margin-bottom: 22px;
      backdrop-filter: blur(8px); transition: all 0.3s ease;
    }

    .post:hover { border-color: var(--accent1); transform: translateY(-2px); }

    .post-header {
      display: flex; justify-content: space-between; align-items: center;
      margin-bottom: 12px; font-size: 0.98rem; color: var(--muted);
      flex-wrap: wrap; gap: 8px;
    }

    .username { color: var(--accent2); font-weight: 600; text-shadow: 0 0 8px rgba(255,255,255,0.3); }
    .city { color: var(--accent1); font-weight: 600; }

    .vote-ratio {
      font-size: 0.85rem;
      color: var(--muted);
      margin-left: 8px;
    }

    .actions { 
      display: flex; gap: 16px; font-size: 0.95rem; margin-top: 12px; 
      flex-wrap: wrap; align-items: center;
    }
    .vote-btn { cursor: pointer; transition: all 0.2s; user-select: none; color: var(--text) !important; }
    .vote-btn:hover { color: var(--accent1) !important; text-shadow: var(--glow); transform: scale(1.05); }
    .delete-btn { color: #ff4d4d !important; cursor: pointer; }
    .delete-btn:hover { color: #ff8080 !important; }

    .comments { margin-top: 16px; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 12px; }
    .comment {
      font-size: 0.92rem;
      margin-bottom: 10px;
      padding: 10px;
      background: rgba(0,0,0,0.25);
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,0.08);
    }
    .comment-header { 
      font-size: 0.85rem; color: var(--muted); margin-bottom: 6px; 
      display: flex; justify-content: space-between; align-items: center; 
      flex-wrap: wrap; gap: 8px;
    }
    .comment-votes { display: flex; gap: 12px; font-size: 0.9rem; flex-wrap: wrap; }

    .add-comment, .dm-box, .reply-box { 
      display: flex; gap: 8px; margin-top: 12px; flex-wrap: wrap; 
    }
    .add-comment input, .dm-box input, .reply-box input { 
      flex: 1; min-width: 200px; padding: 10px; font-size: 0.95rem; 
      background: rgba(20,30,50,0.95) !important; border: 1px solid var(--accent-border); 
      border-radius: 8px; color: white !important; margin: 0;
    }
    .add-comment button, .dm-box button, .reply-box button { 
      padding: 10px 18px; font-size: 0.95rem; margin-top: 0; 
    }

    .empty { text-align: center; color: #6699cc; padding: 60px 0; font-size: 1.3rem; opacity: 0.85; }

    .stat-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-top: 20px;
    }

    .stat-card {
      background: rgba(0, 240, 255, 0.05);
      border: 1px solid var(--accent-border);
      border-radius: 12px;
      padding: 16px;
      text-align: center;
    }

    .stat-value {
      font-size: 2rem;
      font-weight: bold;
      color: var(--accent1);
      margin: 8px 0;
    }

    .stat-label {
      font-size: 0.9rem;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    #dmModal {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.8);
      z-index: 1000;
      padding: 20px;
      overflow-y: auto;
    }

    .modal-content {
      max-width: 600px;
      margin: 40px auto;
      background: var(--panel);
      border: 2px solid var(--accent1);
      border-radius: 18px;
      padding: 24px;
      position: relative;
    }

    .close-btn {
      position: absolute;
      top: 10px;
      right: 10px;
      background: none;
      border: none;
      color: var(--text) !important;
      font-size: 1.5rem;
      cursor: pointer;
      padding: 8px;
      margin: 0;
    }

    #dmMessages {
      max-height: 400px;
      overflow-y: auto;
      background: rgba(0,0,0,0.3);
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 16px;
    }

    .post-context {
      background: rgba(0, 240, 255, 0.1);
      border-left: 3px solid var(--accent1);
      padding: 8px 12px;
      margin-bottom: 12px;
      border-radius: 4px;
      font-size: 0.85rem;
      color: var(--muted);
    }

    @media (max-width: 768px) {
      h1 { font-size: 2.5rem; }
      .container { padding: 15px 10px; }
      .stat-grid { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body style="background-color: rgb(10, 14, 23); color: rgb(224, 247, 255);">

  <canvas id="particles" width="1366" height="599"></canvas>
  <div class="scanlines"></div>

  <div class="container">
    <header>
      <h1>Feeling Hypomanic</h1>
      <div class="tagline">Your mind unleashed! <span id="statusBadge"><span style="color: #ffff00; font-weight: bold;">STATUS: 16</span></span></div>
    </header>

    <!-- Settings Panel -->
    <div class="panel">
      <div style="margin-bottom: 20px;">
        <label><i class="fas fa-map-marker-alt"></i> Location</label>
        <div style="display: flex; gap: 12px; margin-top: 8px; align-items: center; flex-wrap: wrap;">
          <div style="flex: 1; min-width: 200px;">
            <div style="color: var(--accent1); font-weight: 600; font-size: 1.1rem; padding: 10px 0;" id="cityDisplay">Fort Worth</div>
            <small id="timezoneDisplay" style="display: block; color: var(--muted); font-size: 0.9rem;">‚è∞ Timezone: CST (America/Chicago)</small>
          </div>
          <button onclick="toggleLocationMode()"><i class="fas fa-sync-alt"></i> <span id="locationModeBtn">Set Location</span></button>
        </div>
        <div id="setLocationBox" style="display: none; margin-top: 12px;">
          <input id="setLocation" placeholder="Enter city name..." style="margin-bottom: 8px;">
          <button onclick="applySetLocation()">Apply</button>
          <button onclick="cancelSetLocation()">Cancel</button>
        </div>
      </div>

      <div style="margin: 20px 0;">
        <label><i class="fas fa-palette"></i> Customize Colors</label>
        <div style="display: flex; gap: 16px; margin-top: 10px; align-items: center; flex-wrap: wrap;">
          <div>
            <label style="font-size: 0.9rem; display: block; margin-bottom: 4px;">Background</label>
            <input type="color" id="bgColor" value="#0a0e17" onchange="updateColors()">
          </div>
          <div>
            <label style="font-size: 0.9rem; display: block; margin-bottom: 4px;">Text</label>
            <input type="color" id="textColor" value="#e0f7ff" onchange="updateColors()">
          </div>
          <div>
            <label style="font-size: 0.9rem; display: block; margin-bottom: 4px;">Ad Color</label>
            <input type="color" id="adColor" value="#ffff00" onchange="updateAdColor()">
          </div>
        </div>
        <div style="margin-top: 16px; display: flex; gap: 16px; align-items: flex-end; flex-wrap: wrap;">
          <div>
            <label style="font-size: 0.9rem; display: block; margin-bottom: 4px;">Accent 1</label>
            <input type="color" id="accent1Color" value="#00f0ff" onchange="updateAccentColors()">
          </div>
          <div>
            <label style="font-size: 0.9rem; display: block; margin-bottom: 4px;">Accent 2</label>
            <input type="color" id="accent2Color" value="#ff00aa" onchange="updateAccentColors()">
          </div>
        </div>
        <div style="margin-top: 12px;">
          <button onclick="invertColors()" style="padding: 10px 16px; margin-right: 8px;"><i class="fas fa-exchange-alt"></i> Invert</button>
          <button onclick="resetColors()" style="padding: 10px 16px;">Reset All</button>
        </div>
        <small id="colorError" style="display: block; margin-top: 6px; color: #ff4d4d; font-size: 0.85rem;"></small>
      </div>

      <button onclick="wipeEverything()" style="background: linear-gradient(135deg, #ff4d4d, #cc0000);">
        <i class="fas fa-bomb"></i> Complete Wipe (Everything)
      </button>
    </div>

    <!-- Post Box -->
    <div class="panel">
      <div class="format-toolbar">
        <button class="format-btn" onclick="insertFormat(&#39;postText&#39;, &#39;**&#39;, &#39;**&#39;)" title="Bold"><b>B</b></button>
        <button class="format-btn" onclick="insertFormat(&#39;postText&#39;, &#39;*&#39;, &#39;*&#39;)" title="Italic"><i>I</i></button>
        <button class="format-btn" onclick="insertFormat(&#39;postText&#39;, &#39;__&#39;, &#39;__&#39;)" title="Underline"><u>U</u></button>
        <button class="format-btn" onclick="insertFormat(&#39;postText&#39;, &#39;==&#39;, &#39;==&#39;)" title="Highlight">H</button>
      </div>
      <textarea id="postText" placeholder="Say what you wanna say... (no limits)
Ctrl+Enter to post ‚Ä¢ Shift+Enter for new line
Use formatting: **bold** *italic* __underline__ ==highlight==" onkeydown="handlePostKeypress(event)"></textarea>
      <button onclick="addPost()">Post</button>
    </div>

    <!-- Tabs -->
    <div class="tabs">
      <button class="tab-btn" onclick="setTab(&#39;recent&#39;)">Recent</button>
      <button class="tab-btn" onclick="setTab(&#39;popular&#39;)">Popular</button>
      <button class="tab-btn" onclick="setTab(&#39;unpopular&#39;)">Unpopular</button>
      <button class="tab-btn active" onclick="setTab(&#39;local&#39;)">Local</button>
      <button class="tab-btn" onclick="setTab(&#39;mine&#39;)">My Posts</button>
      <button class="tab-btn" onclick="setTab(&#39;saved&#39;)"><i class="fas fa-bookmark"></i> Saved</button>
      <button class="tab-btn" onclick="setTab(&#39;messages&#39;)"><i class="fas fa-envelope"></i> Messages</button>
      <button class="tab-btn" onclick="setTab(&#39;stats&#39;)"><i class="fas fa-chart-bar"></i> Stats</button>
    </div>

    <!-- Time Filters & Search -->
    <div class="filters" id="timeFilters" style="display: flex;">
      <span style="color: var(--muted); font-size: 0.9rem;">Time:</span>
      <button class="filter-btn active" onclick="setTimeFilter(&#39;all&#39;)">All Time</button>
      <button class="filter-btn" onclick="setTimeFilter(&#39;hour&#39;)">Past Hour</button>
      <button class="filter-btn" onclick="setTimeFilter(&#39;day&#39;)">Past Day</button>
      <button class="filter-btn" onclick="setTimeFilter(&#39;week&#39;)">Past Week</button>
    </div>

    <div class="search-box" id="searchBox" style="display: flex;">
      <input type="search" id="searchInput" placeholder="Search posts, comments, locations..." oninput="handleSearch()">
      <button onclick="clearSearch()" style="margin: 0; padding: 10px 16px;">Clear</button>
    </div>

    <!-- Content Containers -->
    <div id="posts" style="display: block;">
    </div>
    <div id="messagesContainer" style="display: none;"></div>
    <div id="statsContainer" style="display: none;"></div>
  </div>

  <!-- DM Modal -->
  <div id="dmModal">
    <div class="modal-content">
      <button class="close-btn" onclick="closeDM()">√ó</button>
      <h3 style="margin: 0 0 20px 0; color: var(--accent1);">
        Chat with <span id="dmUsername"></span>
        <button onclick="editNickname()" style="margin: 0; padding: 6px 12px; font-size: 0.85rem; margin-left: 8px;">
          <i class="fas fa-pen"></i> Edit Nickname
        </button>
      </h3>
      <div id="dmPostContext" class="post-context" style="display: none;"></div>
      <div id="nicknameEdit" style="display: none; margin-bottom: 16px;">
        <label style="font-size: 0.9rem;">Nickname</label>
        <input id="dmNickname" placeholder="Give them a nickname..." style="margin: 8px 0 0 0;">
        <button onclick="saveNickname()" style="margin: 8px 8px 0 0; padding: 8px 16px;">Save</button>
        <button onclick="cancelNicknameEdit()" style="margin: 8px 0 0 0; padding: 8px 16px; background: #666;">Cancel</button>
      </div>
      <div id="dmMessages"></div>
      <div style="display: flex; gap: 8px;">
        <input id="dmInput" placeholder="Type a message..." style="flex: 1; padding: 12px; margin: 0;" onkeydown="if(event.key === &#39;Enter&#39;) { event.preventDefault(); sendDM(); }">
        <button onclick="sendDM()" style="margin: 0;">Send</button>
      </div>
    </div>
  </div>


  <script>
    // ===== PARTICLE BACKGROUND =====
    const canvas = document.getElementById('particles');
    const ctx = canvas.getContext('2d');
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;

    let particlesArray = [];
    const numParticles = 80;

    class Particle {
      constructor() {
        this.x = Math.random() * canvas.width;
        this.y = Math.random() * canvas.height;
        this.size = Math.random() * 3 + 1;
        this.speedX = Math.random() * 0.8 - 0.4;
        this.speedY = Math.random() * 0.8 - 0.4;
        this.color = '#00f0ff';
      }
      update() {
        this.x += this.speedX;
        this.y += this.speedY;
        if (this.x > canvas.width || this.x < 0) this.speedX *= -1;
        if (this.y > canvas.height || this.y < 0) this.speedY *= -1;
      }
      draw() {
        ctx.fillStyle = this.color;
        ctx.shadowBlur = 15;
        ctx.shadowColor = this.color;
        ctx.beginPath();
        ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
        ctx.fill();
      }
    }

    function initParticles() { 
      particlesArray = Array.from({length: numParticles}, () => new Particle()); 
    }
    
    function animateParticles() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      particlesArray.forEach(p => { p.update(); p.draw(); });
      requestAnimationFrame(animateParticles);
    }

    window.addEventListener('resize', () => {
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;
      initParticles();
    });

    initParticles();
    animateParticles();

    // ===== SOUNDS =====
    function _tone(freq, dur, type = 'sine', vol = 0.12) {
      try {
        const ac = new (window.AudioContext || window.webkitAudioContext)();
        const osc = ac.createOscillator();
        const gain = ac.createGain();
        osc.connect(gain); gain.connect(ac.destination);
        osc.type = type;
        osc.frequency.setValueAtTime(freq, ac.currentTime);
        gain.gain.setValueAtTime(vol, ac.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.001, ac.currentTime + dur);
        osc.start(ac.currentTime);
        osc.stop(ac.currentTime + dur);
      } catch(e) {}
    }

    function _chord(freqs, dur, type = 'sine', vol = 0.08) {
      freqs.forEach(f => _tone(f, dur, type, vol));
    }

    function playSound(type) {
      switch(type) {
        case 'post':    _chord([440, 554, 659], 0.25, 'sine'); break;
        case 'comment': _tone(600, 0.12, 'sine'); break;
        case 'upvote':  _chord([523, 659], 0.15, 'sine'); break;
        case 'downvote':_tone(200, 0.2, 'sawtooth', 0.07); break;
        case 'mid':     _tone(440, 0.1, 'triangle'); break;
        case 'save':    _chord([523, 784], 0.2, 'sine'); break;
        case 'delete':  _tone(150, 0.3, 'sawtooth', 0.06); break;
        case 'dm':      _chord([392, 523], 0.18, 'sine'); break;
        case 'reply':   _tone(550, 0.1, 'sine'); break;
        case 'edit':    _tone(480, 0.12, 'triangle'); break;
        case 'report':  _tone(300, 0.15, 'square', 0.05); break;
        default:        _tone(800, 0.05, 'sine', 0.05);
      }
    }

    document.addEventListener('click', () => _tone(800, 0.04, 'sine', 0.04));

    // ===== DATA STRUCTURES =====
    let posts = JSON.parse(localStorage.getItem('hypomanicPosts')) || [];
    let myPostIds = JSON.parse(localStorage.getItem('myPostIds')) || [];
    let myCommentIds = JSON.parse(localStorage.getItem('myCommentIds')) || [];
    let savedPostIds = JSON.parse(localStorage.getItem('savedPostIds')) || [];
    let dmChats = JSON.parse(localStorage.getItem('dmChats')) || {};
    let dmRequests = JSON.parse(localStorage.getItem('dmRequests')) || [];
    let closedAds = JSON.parse(localStorage.getItem('closedAds')) || [];
    let currentDMUser = null;
    let settings = JSON.parse(localStorage.getItem('hypomanicSettings')) || {
      city: "",
      timezone: "",
      bgColor: "#0a0e17",
      textColor: "#e0f7ff",
      adColor: "#ffff00",
      accent1: "#00f0ff",
      accent2: "#ff00aa",
      borderColor: "#ffffff",
      brightness: 10,
      locationMode: "default",
      setLocation: "",
      myVoteRatio: { up: 0, down: 0, mid: 0 }
    };

    let currentTab = 'recent';
    let currentTimeFilter = 'all';
    let isTyping = false;
    let typingTimeout = null;
    let searchQuery = '';

    // ===== USERNAME GENERATION =====
    function generateRandomUsername() {
      const chars = 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!@#$%^&*_-+=[]{}?';
      const length = Math.floor(Math.random() * 6) + 8;
      let username = '';
      for (let i = 0; i < length; i++) {
        username += chars.charAt(Math.floor(Math.random() * chars.length));
      }
      return username;
    }

    // ===== FAKE CONTENT =====
    const usCities = [
      "Austin", "Houston", "Dallas", "San Antonio", "Fort Worth", "El Paso",
      "New York", "Los Angeles", "Chicago", "Phoenix", "Philadelphia", "San Diego",
      "Miami", "Seattle", "Denver", "Boston", "Atlanta", "Portland",
      "Minneapolis", "San Francisco", "Detroit", "Nashville", "Las Vegas",
      "Orlando", "Charlotte", "Baltimore", "Salt Lake City", "Tampa"
    ];

    function generateFakeUsers() {
      const users = [];
      const baseUsers = [];
      for (let i = 0; i < 20; i++) {
        baseUsers.push(generateRandomUsername());
      }
      for (let i = 0; i < 30; i++) {
        users.push({
          username: baseUsers[Math.floor(Math.random() * baseUsers.length)],
          city: usCities[Math.floor(Math.random() * usCities.length)]
        });
      }
      return users;
    }

    const fakeUsers = generateFakeUsers();
    function getRandomFakeUser() { return fakeUsers[Math.floor(Math.random() * fakeUsers.length)]; }

    const fakePostPhrases = [
      "Just cracked the grid ‚Äì total freedom.", "AI overlords incoming? Discuss.",
      "Hypomanic energy at max tonight.", "Reality feels optional today.",
      "Three days no sleep. Seeing patterns everywhere.", "The simulation is leaking again.",
      "Downloaded my consciousness into the cloud.", "Found the frequency. Everything's connected.",
      "My third eye has WiFi.", "Speed of thought exceeds speed of light."
    ];

    const fakeCommentPhrases = [
      "This hits different.", "Same wavelength fr.", "Big if true.", "Felt that.",
      "Real recognize real.", "Based take.", "Mind = blown.", "This resonates.",
      "Confirmed.", "Preach."
    ];

    const funnyAdTexts = [
      "üö® URGENT: Your computer has 47 viruses! Click here to download more! üö®",
      "üí∞ Nigerian Prince needs YOUR help! Only $10,000 required! üí∞",
      "üî• Hot CPUs in your area want to overheat! üî•",
      "‚ö° Elon Musk hates this ONE WEIRD TRICK! ‚ö°",
      "üé∞ Congratulations! You're visitor #1,000,000! Click to claim your free iPad! üé∞",
      "üçï Doctors HATE him for eating pizza and losing weight! üçï",
      "üëΩ Aliens are trying to contact you via THIS LINK! üëΩ",
      "üíä Grow 6 inches taller OVERNIGHT with this magic bean! üíä",
      "üéÆ Free Robux Generator (NOT A SCAM) (WORKING 2026) üéÆ",
      "üß† Increase your IQ by 200 points with this simple browser extension! üß†"
    ];

    const genericReplies = [
      "ok", "cool", "nice", "yeah", "true", "fr", "bet", "word", "facts", "real", 
      "same", "mood", "lol", "lmao", "oof", "rip", "yep", "nah", "bruh", "damn"
    ];

    function getRandomPhrase(arr) { return arr[Math.floor(Math.random() * arr.length)]; }

    // ===== TEXT FORMATTING =====
    function insertFormat(textareaId, before, after) {
      const textarea = document.getElementById(textareaId);
      const start = textarea.selectionStart;
      const end = textarea.selectionEnd;
      const selectedText = textarea.value.substring(start, end);
      const replacement = before + selectedText + after;
      textarea.value = textarea.value.substring(0, start) + replacement + textarea.value.substring(end);
      textarea.focus();
      textarea.setSelectionRange(start + before.length, start + before.length + selectedText.length);
    }

    function parseFormatting(text) {
      text = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
      text = text.replace(/\*(.*?)\*/g, '<em>$1</em>');
      text = text.replace(/__(.*?)__/g, '<u>$1</u>');
      text = text.replace(/==(.*?)==/g, '<mark>$1</mark>');
      return text.replace(/\n/g, '<br>');
    }

    function handlePostKeypress(e) {
      if (e.ctrlKey && e.key === 'Enter') {
        e.preventDefault();
        addPost();
      } else if (e.shiftKey && e.key === 'Enter') {
        // Allow normal newline
      } else if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        addPost();
      }
    }

    // ===== LOCATION =====
    function getTimezoneInitials(tz) {
      const timezoneMap = {
        'America/New_York': 'EST', 'America/Chicago': 'CST',
        'America/Denver': 'MST', 'America/Los_Angeles': 'PST',
        'America/Phoenix': 'MST', 'America/Anchorage': 'AKST',
        'Pacific/Honolulu': 'HST'
      };
      return timezoneMap[tz] || tz.split('/').pop().replace(/_/g, ' ');
    }

    function updateDisplays() {
      const tzDisplay = document.getElementById('timezoneDisplay');
      const tzInitials = getTimezoneInitials(settings.timezone);
      tzDisplay.textContent = `‚è∞ Timezone: ${tzInitials} (${settings.timezone})`;
      const cityDisplay = document.getElementById('cityDisplay');
      if (settings.locationMode === 'set' && settings.setLocation) {
        cityDisplay.textContent = `${settings.setLocation} (Set)`;
      } else {
        cityDisplay.textContent = settings.city || "Detecting...";
      }
      const status = calculateStatus();
      document.getElementById('statusBadge').innerHTML = `<span style="color: ${getStatusColor(status)}; font-weight: bold;">STATUS: ${status}</span>`;
    }

    async function detectCity() {
      try {
        const response = await fetch('https://ipapi.co/json/');
        const data = await response.json();
        if (data.city) {
          settings.city = data.city;
          if (!settings.timezone) {
            settings.timezone = data.timezone || Intl.DateTimeFormat().resolvedOptions().timeZone;
          }
          localStorage.setItem('hypomanicSettings', JSON.stringify(settings));
          updateDisplays();
        } else {
          fallbackCityDetection();
        }
      } catch (error) {
        fallbackCityDetection();
      }
    }

    function fallbackCityDetection() {
      const tz = settings.timezone || Intl.DateTimeFormat().resolvedOptions().timeZone;
      settings.timezone = tz;
      const tzCityMap = {
        'America/Chicago': 'Fort Worth', 'America/New_York': 'New York',
        'America/Los_Angeles': 'Los Angeles', 'America/Denver': 'Denver',
        'America/Phoenix': 'Phoenix', 'America/Anchorage': 'Anchorage',
        'Pacific/Honolulu': 'Honolulu'
      };
      settings.city = tzCityMap[tz] || 'Unknown';
      localStorage.setItem('hypomanicSettings', JSON.stringify(settings));
      updateDisplays();
    }

    function toggleLocationMode() {
      if (settings.locationMode === 'default') {
        document.getElementById('setLocationBox').style.display = 'block';
        document.getElementById('locationModeBtn').textContent = 'Use Default';
      } else {
        settings.locationMode = 'default';
        settings.setLocation = '';
        document.getElementById('setLocationBox').style.display = 'none';
        document.getElementById('locationModeBtn').textContent = 'Set Location';
        localStorage.setItem('hypomanicSettings', JSON.stringify(settings));
        updateDisplays();
        if (currentTab === 'recent' || currentTab === 'local') {
          renderPosts();
        }
      }
    }

    function applySetLocation() {
      const loc = document.getElementById('setLocation').value.trim();
      if (loc) {
        settings.locationMode = 'set';
        settings.setLocation = loc;
        document.getElementById('setLocationBox').style.display = 'none';
        document.getElementById('locationModeBtn').textContent = 'Use Default';
        localStorage.setItem('hypomanicSettings', JSON.stringify(settings));
        updateDisplays();
        if (currentTab === 'recent' || currentTab === 'local') {
          renderPosts();
        }
      }
    }

    function cancelSetLocation() {
      document.getElementById('setLocationBox').style.display = 'none';
      document.getElementById('setLocation').value = '';
    }

    function getCurrentViewLocation() {
      return settings.locationMode === 'set' && settings.setLocation ? settings.setLocation : settings.city;
    }

    function getPostLocation() {
      return settings.city || "Unknown";
    }

    if (!settings.timezone) {
      settings.timezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
    }
    updateDisplays();
    detectCity();

    // ===== COLOR MANAGEMENT =====
    function updateColors() {
      const bgColor = document.getElementById('bgColor').value;
      const textColor = document.getElementById('textColor').value;
      const errorDiv = document.getElementById('colorError');
      
      if (bgColor.toLowerCase() === textColor.toLowerCase()) {
        errorDiv.textContent = "‚ö†Ô∏è Background and text colors cannot be the same!";
        return;
      }
      
      const r = parseInt(bgColor.slice(1, 3), 16);
      const g = parseInt(bgColor.slice(3, 5), 16);
      const b = parseInt(bgColor.slice(5, 7), 16);
      const brightness = (r * 299 + g * 587 + b * 114) / 1000;
      
      const tr = parseInt(textColor.slice(1, 3), 16);
      const tg = parseInt(textColor.slice(3, 5), 16);
      const tb = parseInt(textColor.slice(5, 7), 16);
      const textBrightness = (tr * 299 + tg * 587 + tb * 114) / 1000;
      
      if (Math.abs(brightness - textBrightness) < 100) {
        errorDiv.textContent = "‚ö†Ô∏è Colors may be hard to read - low contrast!";
      } else {
        errorDiv.textContent = "";
      }
      
      const borderColor = brightness > 128 ? '#000000' : '#ffffff';
      document.body.style.backgroundColor = bgColor;
      document.body.style.color = textColor;
      document.documentElement.style.setProperty('--text', textColor);
      document.documentElement.style.setProperty('--muted', textColor);
      
      settings.bgColor = bgColor;
      settings.textColor = textColor;
      settings.borderColor = borderColor;
      settings.brightness = brightness;
      localStorage.setItem('hypomanicSettings', JSON.stringify(settings));
    }

    function updateAccentColors() {
      const a1 = document.getElementById('accent1Color').value;
      const a2 = document.getElementById('accent2Color').value;
      document.documentElement.style.setProperty('--accent1', a1);
      document.documentElement.style.setProperty('--accent2', a2);
      settings.accent1 = a1;
      settings.accent2 = a2;
      localStorage.setItem('hypomanicSettings', JSON.stringify(settings));
    }

    if (settings.accent1) {
      document.documentElement.style.setProperty('--accent1', settings.accent1);
      document.getElementById('accent1Color').value = settings.accent1;
    }
    if (settings.accent2) {
      document.documentElement.style.setProperty('--accent2', settings.accent2);
      document.getElementById('accent2Color').value = settings.accent2;
    }

    function updateAdColor() {
      const adColor = document.getElementById('adColor').value;
      settings.adColor = adColor;
      const r = parseInt(adColor.slice(1, 3), 16);
      const g = parseInt(adColor.slice(3, 5), 16);
      const b = parseInt(adColor.slice(5, 7), 16);
      document.documentElement.style.setProperty('--ad-color', `rgba(${r}, ${g}, ${b}, 0.1)`);
      localStorage.setItem('hypomanicSettings', JSON.stringify(settings));
    }

    function invertColors() {
      const tempBg = document.getElementById('bgColor').value;
      const tempText = document.getElementById('textColor').value;
      document.getElementById('bgColor').value = tempText;
      document.getElementById('textColor').value = tempBg;
      updateColors();
    }

    function resetColors() {
      settings.bgColor = "#0a0e17";
      settings.textColor = "#e0f7ff";
      settings.adColor = "#ffff00";
      settings.accent1 = "#00f0ff";
      settings.accent2 = "#ff00aa";
      settings.borderColor = "#ffffff";
      settings.brightness = 10;
      document.body.style.backgroundColor = settings.bgColor;
      document.body.style.color = settings.textColor;
      document.getElementById('bgColor').value = settings.bgColor;
      document.getElementById('textColor').value = settings.textColor;
      document.getElementById('adColor').value = settings.adColor;
      document.getElementById('accent1Color').value = settings.accent1;
      document.getElementById('accent2Color').value = settings.accent2;
      document.getElementById('colorError').textContent = "";
      document.documentElement.style.setProperty('--ad-color', 'rgba(255, 255, 0, 0.1)');
      document.documentElement.style.setProperty('--accent1', settings.accent1);
      document.documentElement.style.setProperty('--accent2', settings.accent2);
      localStorage.setItem('hypomanicSettings', JSON.stringify(settings));
    }

    if (settings.bgColor && settings.textColor) {
      document.body.style.backgroundColor = settings.bgColor;
      document.body.style.color = settings.textColor;
      document.getElementById('bgColor').value = settings.bgColor;
      document.getElementById('textColor').value = settings.textColor;
      if (settings.adColor) {
        document.getElementById('adColor').value = settings.adColor;
        const r = parseInt(settings.adColor.slice(1, 3), 16);
        const g = parseInt(settings.adColor.slice(3, 5), 16);
        const b = parseInt(settings.adColor.slice(5, 7), 16);
        document.documentElement.style.setProperty('--ad-color', `rgba(${r}, ${g}, ${b}, 0.1)`);
      }
    }

    // ===== STATUS =====
    function calculateStatus() {
      let karma = 0;
      posts.forEach(p => {
        if (myPostIds.includes(p.id)) {
          karma += (p.upvotes || 0) - (p.downvotes || 0);
        }
        p.comments.forEach((c, idx) => {
          if (myCommentIds.includes(`${p.id}-${idx}`)) {
            karma += (c.upvotes || 0) - (c.downvotes || 0);
          }
        });
      });
      return Math.max(0, Math.round(karma));
    }

    function getStatusColor(status) {
      if (status > 100) return '#00ff00';
      if (status > 50) return '#7fff00';
      if (status > 0) return '#ffff00';
      return '#888888';
    }

    // ===== VOTING =====
    function votePost(id, dir) {
      const p = posts.find(p => p.id === id);
      if (!p) return;
      
      if (dir === 'up') {
        p.upvotes = (p.upvotes || 0) + 1;
        if (settings.myVoteRatio) settings.myVoteRatio.up++;
        playSound('upvote');
      } else if (dir === 'down') {
        p.downvotes = (p.downvotes || 0) + 1;
        if (settings.myVoteRatio) settings.myVoteRatio.down++;
        playSound('downvote');
      } else if (dir === 'mid') {
        if (Math.random() < 0.5) {
          p.upvotes = (p.upvotes || 0) + 0.5;
        } else {
          p.downvotes = (p.downvotes || 0) + 0.5;
        }
        if (settings.myVoteRatio) settings.myVoteRatio.mid++;
        playSound('mid');
      }
      localStorage.setItem('hypomanicPosts', JSON.stringify(posts));
      localStorage.setItem('hypomanicSettings', JSON.stringify(settings));
      renderPosts();
      if (dir !== 'mid') { cascadeVotes(id, dir); }
    }

    function voteComment(postId, commentIndex, dir) {
      const post = posts.find(p => p.id === postId);
      if (!post || !post.comments[commentIndex]) return;
      const c = post.comments[commentIndex];
      if (!c.upvotes) c.upvotes = 0;
      if (!c.downvotes) c.downvotes = 0;
      
      if (dir === 'up') {
        c.upvotes++;
        if (settings.myVoteRatio) settings.myVoteRatio.up++;
        playSound('upvote');
      } else if (dir === 'down') {
        c.downvotes++;
        if (settings.myVoteRatio) settings.myVoteRatio.down++;
        playSound('downvote');
      } else if (dir === 'mid') {
        if (Math.random() < 0.5) {
          c.upvotes += 0.5;
        } else {
          c.downvotes += 0.5;
        }
        if (settings.myVoteRatio) settings.myVoteRatio.mid++;
        playSound('mid');
      }
      localStorage.setItem('hypomanicPosts', JSON.stringify(posts));
      localStorage.setItem('hypomanicSettings', JSON.stringify(settings));
      renderPosts();
    }

    function cascadeVotes(postId, direction) {
      const additionalVotes = Math.floor(Math.random() * 3) + 1;
      setTimeout(() => {
        const p = posts.find(p => p.id === postId);
        if (p) {
          if (direction === 'up') {
            p.upvotes = (p.upvotes || 0) + additionalVotes;
          } else {
            p.downvotes = (p.downvotes || 0) + additionalVotes;
          }
          localStorage.setItem('hypomanicPosts', JSON.stringify(posts));
        }
      }, Math.random() * 2000 + 500);
    }

    // ===== POSTS/COMMENTS =====
    function addPost() {
      const text = document.getElementById('postText').value.trim();
      if (!text) return;
      const postId = Date.now();
      const post = {
        id: postId,
        text,
        username: generateRandomUsername(),
        city: getPostLocation(),
        timestamp: Date.now(),
        editedAt: null,
        upvotes: 0,
        downvotes: 0,
        comments: []
      };
      posts.unshift(post);
      myPostIds.push(postId);
      localStorage.setItem('hypomanicPosts', JSON.stringify(posts));
      localStorage.setItem('myPostIds', JSON.stringify(myPostIds));
      document.getElementById('postText').value = "";
      playSound('post');
      renderPosts();
      updateDisplays();
    }

    function addComment(id, text, replyToIndex = null) {
      const p = posts.find(p => p.id === id);
      if (p && text.trim()) {
        const commentIndex = p.comments.length;
        const newComment = {
          username: generateRandomUsername(),
          city: getPostLocation(),
          timestamp: Date.now(),
          editedAt: null,
          text: text.trim(),
          upvotes: 0,
          downvotes: 0,
          replyTo: replyToIndex
        };
        p.comments.push(newComment);
        myCommentIds.push(`${id}-${commentIndex}`);
        localStorage.setItem('hypomanicPosts', JSON.stringify(posts));
        localStorage.setItem('myCommentIds', JSON.stringify(myCommentIds));
        playSound('comment');
        if (Math.random() < 0.3) {
          generateAIComment(id);
        }
        if (Math.random() < 0.5) {
          generateAIPosts(1);
        }
        renderPosts();
        updateDisplays();
      }
    }

    function deletePost(id) {
      playSound('delete');
      if (confirm("Erase this post? This will decrease your STATUS.")) {
        posts = posts.filter(p => p.id !== id);
        myPostIds = myPostIds.filter(pid => pid !== id);
        savedPostIds = savedPostIds.filter(pid => pid !== id);
        localStorage.setItem('hypomanicPosts', JSON.stringify(posts));
        localStorage.setItem('myPostIds', JSON.stringify(myPostIds));
        localStorage.setItem('savedPostIds', JSON.stringify(savedPostIds));
        renderPosts();
        updateDisplays();
      }
    }

    function deleteComment(postId, commentIndex) {
      playSound('delete');
      if (confirm("Erase this comment? This will decrease your STATUS.")) {
        const post = posts.find(p => p.id === postId);
        if (post && post.comments[commentIndex]) {
          post.comments.splice(commentIndex, 1);
          myCommentIds = myCommentIds.filter(cid => cid !== `${postId}-${commentIndex}`);
          const newCommentIds = [];
          myCommentIds.forEach(cid => {
            const [pid, idx] = cid.split('-');
            if (parseInt(pid) === postId && parseInt(idx) > commentIndex) {
              newCommentIds.push(`${pid}-${parseInt(idx) - 1}`);
            } else if (parseInt(pid) !== postId) {
              newCommentIds.push(cid);
            }
          });
          myCommentIds = newCommentIds;
          localStorage.setItem('hypomanicPosts', JSON.stringify(posts));
          localStorage.setItem('myCommentIds', JSON.stringify(myCommentIds));
          renderPosts();
          updateDisplays();
        }
      }
    }

    function editPost(id) {
      playSound('edit');
      const post = posts.find(p => p.id === id);
      if (!post) return;
      const newText = prompt("Edit your post:", post.text.replace(' [redacted some]', ''));
      if (newText !== null && newText.trim()) {
        post.text = newText.trim() + " [redacted some]";
        post.editedAt = Date.now();
        localStorage.setItem('hypomanicPosts', JSON.stringify(posts));
        renderPosts();
      }
    }

    function reportPost(id) {
      playSound('report');
      if (confirm("Report this post? It will be removed from your view.")) {
        posts = posts.filter(p => p.id !== id);
        localStorage.setItem('hypomanicPosts', JSON.stringify(posts));
        renderPosts();
        alert("Post reported and removed from your feed.");
      }
    }

    function savePost(id) {
      playSound('save');
      if (savedPostIds.includes(id)) {
        savedPostIds = savedPostIds.filter(pid => pid !== id);
      } else {
        savedPostIds.push(id);
      }
      localStorage.setItem('savedPostIds', JSON.stringify(savedPostIds));
      renderPosts();
    }

    function wipeEverything() {
      if (confirm("This will PERMANENTLY DELETE EVERYTHING: posts, comments, messages, saved posts, and RESET STATUS TO 0. This cannot be undone!")) {
        posts = posts.filter(p => !myPostIds.includes(p.id));
        posts.forEach(p => {
          p.comments = p.comments.filter((c, idx) => !myCommentIds.includes(`${p.id}-${idx}`));
        });
        myPostIds = [];
        myCommentIds = [];
        savedPostIds = [];
        dmChats = {};
        dmRequests = [];
        settings.myVoteRatio = { up: 0, down: 0, mid: 0 };
        localStorage.setItem('hypomanicPosts', JSON.stringify(posts));
        localStorage.setItem('myPostIds', JSON.stringify(myPostIds));
        localStorage.setItem('myCommentIds', JSON.stringify(myCommentIds));
        localStorage.setItem('savedPostIds', JSON.stringify(savedPostIds));
        localStorage.setItem('dmChats', JSON.stringify(dmChats));
        localStorage.setItem('dmRequests', JSON.stringify(dmRequests));
        localStorage.setItem('hypomanicSettings', JSON.stringify(settings));
        renderPosts();
        updateDisplays();
        alert("Everything has been wiped.");
      }
    }

    function closeAd(adId) {
      closedAds.push(adId);
      localStorage.setItem('closedAds', JSON.stringify(closedAds));
      renderPosts();
    }

    // ===== AI =====
    function generateAIPosts(num = 1) {
      for (let i = 0; i < num; i++) {
        const fake = getRandomFakeUser();
        const post = {
          id: Date.now() + i + Math.random() * 1000,
          text: getRandomPhrase(fakePostPhrases),
          username: fake.username,
          city: fake.city,
          timestamp: Date.now() - Math.random() * 3600000,
          editedAt: null,
          upvotes: Math.floor(Math.random() * 10),
          downvotes: Math.floor(Math.random() * 3),
          comments: []
        };
        posts.unshift(post);
      }
      localStorage.setItem('hypomanicPosts', JSON.stringify(posts));
    }

    function generateAIComment(postId) {
      const post = posts.find(p => p.id === postId);
      if (!post) return;
      const numComments = Math.random() < 0.5 ? 0 : 1;
      for (let i = 0; i < numComments; i++) {
        let fake;
        if (settings.city && Math.random() < 0.6) {
          const localUsers = fakeUsers.filter(u => u.city.toLowerCase() === settings.city.toLowerCase());
          fake = localUsers.length > 0 ? localUsers[Math.floor(Math.random() * localUsers.length)] : getRandomFakeUser();
        } else {
          fake = getRandomFakeUser();
        }
        let replyTo = null;
        if (post.comments.length > 0 && Math.random() < 0.2) {
          replyTo = Math.floor(Math.random() * post.comments.length);
        }
        post.comments.push({
          username: fake.username,
          city: fake.city,
          timestamp: Date.now() + Math.random() * 60000,
          editedAt: null,
          text: getRandomPhrase(fakeCommentPhrases),
          upvotes: Math.floor(Math.random() * 8),
          downvotes: Math.floor(Math.random() * 2),
          replyTo: replyTo
        });
      }
      localStorage.setItem('hypomanicPosts', JSON.stringify(posts));
    }

    function autoVotePosts() {
      if (posts.length > 0 && Math.random() < 0.4) {
        const randomPost = posts[Math.floor(Math.random() * posts.length)];
        const voteType = Math.random();
        if (voteType < 0.4) {
          randomPost.upvotes = (randomPost.upvotes || 0) + 1;
        } else if (voteType < 0.75) {
          randomPost.downvotes = (randomPost.downvotes || 0) + 1;
        } else {
          if (Math.random() < 0.5) {
            randomPost.upvotes = (randomPost.upvotes || 0) + 0.5;
          } else {
            randomPost.downvotes = (randomPost.downvotes || 0) + 0.5;
          }
        }
        localStorage.setItem('hypomanicPosts', JSON.stringify(posts));
      }
    }

    function autoVoteComments() {
      if (posts.length > 0 && Math.random() < 0.3) {
        const postsWithComments = posts.filter(p => p.comments.length > 0);
        if (postsWithComments.length > 0) {
          const randomPost = postsWithComments[Math.floor(Math.random() * postsWithComments.length)];
          const randomComment = randomPost.comments[Math.floor(Math.random() * randomPost.comments.length)];
          const voteType = Math.random();
          if (!randomComment.upvotes) randomComment.upvotes = 0;
          if (!randomComment.downvotes) randomComment.downvotes = 0;
          if (voteType < 0.4) {
            randomComment.upvotes++;
          } else if (voteType < 0.75) {
            randomComment.downvotes++;
          } else {
            if (Math.random() < 0.5) {
              randomComment.upvotes += 0.5;
            } else {
              randomComment.downvotes += 0.5;
            }
          }
          localStorage.setItem('hypomanicPosts', JSON.stringify(posts));
        }
      }
    }

    // ===== HELPERS =====
    function formatTimestamp(timestamp, editedAt) {
      const now = Date.now();
      const useTime = editedAt || timestamp;
      const diff = now - useTime;
      const seconds = Math.floor(diff / 1000);
      const minutes = Math.floor(seconds / 60);
      const hours = Math.floor(minutes / 60);
      const days = Math.floor(hours / 24);
      let timeStr = '';
      if (seconds < 60) timeStr = `${seconds}s ago`;
      else if (minutes < 60) timeStr = `${minutes}m ago`;
      else if (hours < 24) timeStr = `${hours}h ago`;
      else if (days < 7) timeStr = `${days}d ago`;
      else timeStr = new Date(useTime).toLocaleDateString();
      
      if (editedAt) {
        timeStr += ' (edited)';
      }
      return timeStr;
    }

    function getVoteRatio(upvotes, downvotes) {
      const total = upvotes + downvotes;
      if (total === 0) return '0%';
      return `${Math.round((upvotes / total) * 100)}%`;
    }

    function filterPostsByTime(posts) {
      if (currentTimeFilter === 'all') return posts;
      const now = Date.now();
      const filters = {
        'hour': 3600000,
        'day': 86400000,
        'week': 604800000
      };
      const cutoff = now - filters[currentTimeFilter];
      return posts.filter(p => p.timestamp >= cutoff);
    }

    function filterPostsBySearch(posts) {
      if (!searchQuery) return posts;
      return posts.filter(p => {
        const textMatch = p.text.toLowerCase().includes(searchQuery.toLowerCase());
        const usernameMatch = p.username.toLowerCase().includes(searchQuery.toLowerCase());
        const cityMatch = p.city.toLowerCase().includes(searchQuery.toLowerCase());
        const commentMatch = p.comments.some(c => c.text.toLowerCase().includes(searchQuery.toLowerCase()) || c.city.toLowerCase().includes(searchQuery.toLowerCase()));
        return textMatch || usernameMatch || cityMatch || commentMatch;
      });
    }

    // ===== TABS =====
    function setTab(tab) {
      currentTab = tab;
      document.querySelectorAll('.tabs .tab-btn').forEach(b => b.classList.remove('active'));
      event.target.classList.add('active');
      searchQuery = '';
      if (document.getElementById('searchInput')) {
        document.getElementById('searchInput').value = '';
      }
      if (tab === 'messages') {
        document.getElementById('posts').style.display = 'none';
        document.getElementById('messagesContainer').style.display = 'block';
        document.getElementById('statsContainer').style.display = 'none';
        document.getElementById('timeFilters').style.display = 'none';
        document.getElementById('searchBox').style.display = 'none';
        renderMessages();
      } else if (tab === 'stats') {
        document.getElementById('posts').style.display = 'none';
        document.getElementById('messagesContainer').style.display = 'none';
        document.getElementById('statsContainer').style.display = 'block';
        document.getElementById('timeFilters').style.display = 'none';
        document.getElementById('searchBox').style.display = 'none';
        renderStats();
      } else {
        document.getElementById('posts').style.display = 'block';
        document.getElementById('messagesContainer').style.display = 'none';
        document.getElementById('statsContainer').style.display = 'none';
        document.getElementById('timeFilters').style.display = 'flex';
        document.getElementById('searchBox').style.display = 'flex';
        renderPosts();
      }
    }

    function setTimeFilter(filter) {
      currentTimeFilter = filter;
      document.querySelectorAll('.filters .filter-btn').forEach(b => b.classList.remove('active'));
      event.target.classList.add('active');
      renderPosts();
    }

    function handleSearch() {
      searchQuery = document.getElementById('searchInput').value;
      renderPosts();
    }

    function clearSearch() {
      searchQuery = '';
      document.getElementById('searchInput').value = '';
      renderPosts();
    }

    // ===== RENDER =====
    function shouldShowAd(index, tab) {
      if (tab === 'popular' || tab === 'unpopular') {
        return index % 3 === 0 && Math.random() < 0.3;
      }
      return index % 5 === 0 && Math.random() < 0.15;
    }

    function renderPosts() {
      const container = document.getElementById('posts');
      let shown = [...posts];
      shown = filterPostsByTime(shown);
      shown = filterPostsBySearch(shown);
      const viewLocation = getCurrentViewLocation();
      if (currentTab === 'popular') {
        shown.sort((a,b) => ((b.upvotes || 0) - (b.downvotes || 0)) - ((a.upvotes || 0) - (a.downvotes || 0)));
      } else if (currentTab === 'unpopular') {
        shown.sort((a,b) => ((a.upvotes || 0) - (a.downvotes || 0)) - ((b.upvotes || 0) - (b.downvotes || 0)));
      } else if (currentTab === 'local' && viewLocation) {
        shown = shown.filter(p => {
          const postIsLocal = p.city && p.city.toLowerCase() === viewLocation.toLowerCase();
          const hasLocalComments = p.comments.some(c => c.city && c.city.toLowerCase() === viewLocation.toLowerCase());
          return postIsLocal || hasLocalComments;
        });
      } else if (currentTab === 'mine') {
        shown = shown.filter(p => {
          const isMyPost = myPostIds.includes(p.id);
          const hasMyComment = p.comments.some((c, idx) => myCommentIds.includes(`${p.id}-${idx}`));
          return isMyPost || hasMyComment;
        });
      } else if (currentTab === 'saved') {
        shown = shown.filter(p => savedPostIds.includes(p.id));
      }

      let html = "";
      let postCount = 0;

      shown.forEach((p, index) => {
        postCount++;
        const adId = `ad-${currentTab}-${index}`;
        if (shouldShowAd(index, currentTab) && !closedAds.includes(adId)) {
          html += `
            <div class="ad-panel" id="${adId}">
              <div class="ad-badge">AD</div>
              <button class="ad-close" onclick="closeAd('${adId}')">&times;</button>
              <div style="font-size: 1.2rem; font-weight: bold; margin-bottom: 8px;">
                ${getRandomPhrase(funnyAdTexts)}
              </div>
              <button onclick="alert('You fell for it! üòÇ')" style="margin: 0;">
                CLICK HERE NOW!!!
              </button>
            </div>
          `;
        }

        const myPost = myPostIds.includes(p.id);
        const isSaved = savedPostIds.includes(p.id);
        const ratio = getVoteRatio(p.upvotes || 0, p.downvotes || 0);
        const isTravel = settings.locationMode === 'set' && settings.setLocation;

        let commentsHtml = p.comments.map((c, index) => {
          const isMyComment = myCommentIds.includes(`${p.id}-${index}`);
          const commentStyle = isMyComment ? 'border: 2px solid var(--accent1); background: rgba(0, 240, 255, 0.05);' : '';
          const isReply = c.replyTo !== null && c.replyTo !== undefined;
          const indentStyle = isReply ? 'margin-left: 30px; border-left: 2px solid var(--accent-border); padding-left: 12px;' : '';
          const replyToText = isReply && p.comments[c.replyTo] ? `<span style="color: var(--muted); font-size: 0.85rem;">‚Ü≥ replying to @${p.comments[c.replyTo].username}</span><br>` : '';
          const cRatio = getVoteRatio(c.upvotes || 0, c.downvotes || 0);
          
          return `
          <div class="comment" style="${commentStyle}${indentStyle}">
            <div class="comment-header">
              <span>
                <span class="city">[${c.city}]</span> ‚Ä¢ 
                <span class="username">@${c.username}</span> ‚Ä¢ 
                ${formatTimestamp(c.timestamp, c.editedAt)}
                ${isMyComment ? '<span style="color: var(--accent1); font-weight: bold;"> ‚Ä¢ YOU</span>' : ''}
                <span class="vote-ratio">(${cRatio})</span>
              </span>
              <span class="comment-votes">
                <span class="vote-btn" onclick="voteComment(${p.id}, ${index}, 'up')"><i class="fas fa-arrow-up"></i> ${(c.upvotes || 0).toFixed(1)}</span>
                <span class="vote-btn" onclick="voteComment(${p.id}, ${index}, 'mid')" style="color: #888;"><i class="fas fa-minus"></i> Mid</span>
                <span class="vote-btn" onclick="voteComment(${p.id}, ${index}, 'down')"><i class="fas fa-arrow-down"></i> ${(c.downvotes || 0).toFixed(1)}</span>
                <span class="vote-btn" onclick="showReplyBox(${p.id}, ${index})"><i class="fas fa-reply"></i></span>
                ${isMyComment ? `<span class="delete-btn" onclick="deleteComment(${p.id}, ${index})"><i class="fas fa-trash"></i></span>` : ''}
              </span>
            </div>
            ${replyToText}
            ${parseFormatting(c.text)}
            <div id="reply-${p.id}-${index}" class="reply-box" style="display: none;">
              <div class="format-toolbar" style="margin-bottom: 8px;">
                <button class="format-btn" onclick="insertFormat('r${p.id}-${index}', '**', '**')" title="Bold"><b>B</b></button>
                <button class="format-btn" onclick="insertFormat('r${p.id}-${index}', '*', '*')" title="Italic"><i>I</i></button>
                <button class="format-btn" onclick="insertFormat('r${p.id}-${index}', '__', '__')" title="Underline"><u>U</u></button>
                <button class="format-btn" onclick="insertFormat('r${p.id}-${index}', '==', '==')" title="Highlight">H</button>
              </div>
              <input id="r${p.id}-${index}" placeholder="Reply... (Ctrl+Enter to send)" onkeydown="if(event.ctrlKey && event.key === 'Enter') { event.preventDefault(); addComment(${p.id}, this.value, ${index}); this.value=''; document.getElementById('reply-${p.id}-${index}').style.display='none'; } else if (event.key === 'Enter' && !event.shiftKey) { event.preventDefault(); addComment(${p.id}, this.value, ${index}); this.value=''; document.getElementById('reply-${p.id}-${index}').style.display='none'; }" />
              <button onclick="addComment(${p.id}, document.getElementById('r${p.id}-${index}').value, ${index}); document.getElementById('r${p.id}-${index}').value=''; document.getElementById('reply-${p.id}-${index}').style.display='none';">Send</button>
            </div>
          </div>
        `;
        }).join('');

        html += `
          <div class="post">
            <div class="post-header">
              <span>
                <span class="city">[${p.city}]</span>${isTravel ? '<span class="travel-badge">TRAVEL</span>' : ''} ‚Ä¢ 
                <span class="username">@${p.username}</span>
                ${myPost ? '<span style="color: var(--accent1); font-weight: bold;"> ‚Ä¢ YOU</span>' : ''}
                <span class="vote-ratio">(${ratio})</span>
              </span>
              <span>${formatTimestamp(p.timestamp, p.editedAt)}</span>
            </div>
            <div>${parseFormatting(p.text)}</div>
            <div class="actions">
              <span class="vote-btn" onclick="votePost(${p.id}, 'up')"><i class="fas fa-arrow-up"></i> ${(p.upvotes || 0).toFixed(1)}</span>
              <span class="vote-btn" onclick="votePost(${p.id}, 'mid')" style="color: #888;"><i class="fas fa-minus"></i> Mid</span>
              <span class="vote-btn" onclick="votePost(${p.id}, 'down')"><i class="fas fa-arrow-down"></i> ${(p.downvotes || 0).toFixed(1)}</span>
              <span class="vote-btn" onclick="savePost(${p.id})"><i class="fas ${isSaved ? 'fa-bookmark' : 'fa-bookmark-o'}"></i> ${isSaved ? 'Saved' : 'Save'}</span>
              ${myPost ? `
                <span class="vote-btn" onclick="editPost(${p.id})"><i class="fas fa-edit"></i> Edit</span>
                <span class="delete-btn" onclick="deletePost(${p.id})"><i class="fas fa-trash"></i> Erase</span>
              ` : `
                <span class="vote-btn" onclick="toggleDMBox(${p.id}, '${p.username.replace(/'/g, "\\'")}', '${p.text.substring(0, 50).replace(/'/g, "\\'")}...')"><i class="fas fa-paper-plane"></i> DM</span>
                <span class="vote-btn" onclick="reportPost(${p.id})"><i class="fas fa-flag"></i> Report</span>
              `}
            </div>
            <div id="dm-${p.id}" class="dm-box" style="display: none;">
              <input id="dminput-${p.id}" placeholder="Send a message to @${p.username}..." onkeydown="if(event.key === 'Enter' && !event.shiftKey) { event.preventDefault(); sendDirectMessage(${p.id}, '${p.username.replace(/'/g, "\\'")}', this.value, '${p.text.substring(0, 50).replace(/'/g, "\\'")}'); this.value=''; document.getElementById('dm-${p.id}').style.display='none'; }" />
              <button onclick="sendDirectMessage(${p.id}, '${p.username.replace(/'/g, "\\'")}', document.getElementById('dminput-${p.id}').value, '${p.text.substring(0, 50).replace(/'/g, "\\'")}'); document.getElementById('dminput-${p.id}').value=''; document.getElementById('dm-${p.id}').style.display='none';">Send</button>
            </div>
            <div class="comments">
              ${commentsHtml}
              <div class="add-comment">
                <input id="c${p.id}" placeholder="Reply... (Ctrl+Enter to send)" onkeydown="if(event.ctrlKey && event.key === 'Enter') { event.preventDefault(); addComment(${p.id}, this.value); this.value=''; } else if (event.key === 'Enter' && !event.shiftKey) { event.preventDefault(); addComment(${p.id}, this.value); this.value=''; }" />
                <button onclick="addComment(${p.id}, document.getElementById('c${p.id}').value); document.getElementById('c${p.id}').value=''">Send</button>
              </div>
            </div>
          </div>
        `;
      });

      container.innerHTML = html || `<div class="empty">No transmissions yet...</div>`;
    }

    function showReplyBox(postId, commentIndex) {
      playSound('reply');
      const replyBox = document.getElementById(`reply-${postId}-${commentIndex}`);
      if (replyBox) {
        replyBox.style.display = replyBox.style.display === 'none' ? 'block' : 'none';
        if (replyBox.style.display === 'block') {
          document.getElementById(`r${postId}-${commentIndex}`).focus();
        }
      }
    }

    function toggleDMBox(postId, username, postText) {
      playSound('dm');
      const dmBox = document.getElementById(`dm-${postId}`);
      if (dmBox) {
        dmBox.style.display = dmBox.style.display === 'none' ? 'block' : 'none';
        if (dmBox.style.display === 'block') {
          document.getElementById(`dminput-${postId}`).focus();
        }
      }
    }

    function sendDirectMessage(postId, username, text, postText) {
      if (!text || !text.trim()) return;
      if (!dmChats[username]) {
        const intro = prompt(`First message to @${username}! Introduce yourself (this will show in their message request):`, "Hey, call me...");
        if (!intro) return;
        dmRequests.push({ username, postText, intro, initialMessage: text.trim() });
        localStorage.setItem('dmRequests', JSON.stringify(dmRequests));
        alert(`Message request sent to @${username}!`);
        return;
      }
      dmChats[username].messages.push({
        text: text.trim(),
        fromMe: true,
        timestamp: new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' })
      });
      if (!dmChats[username].postContext) {
        dmChats[username].postContext = postText;
      }
      localStorage.setItem('dmChats', JSON.stringify(dmChats));
      if (Math.random() < 0.6) {
        setTimeout(() => {
          if (dmChats[username]) {
            dmChats[username].messages.push({
              text: getRandomPhrase(genericReplies),
              fromMe: false,
              timestamp: new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' })
            });
            localStorage.setItem('dmChats', JSON.stringify(dmChats));
          }
        }, Math.random() * 3000 + 1000);
      }
      alert(`Message sent to @${username}! Check the Messages tab.`);
    }

    // ===== DM =====
    function openDM(username, postText = '') {
      currentDMUser = username;
      const chat = dmChats[username];
      document.getElementById('dmUsername').textContent = `@${username}${chat?.nickname ? ` (${chat.nickname})` : ''}`;
      document.getElementById('dmModal').style.display = 'block';
      if (!dmChats[username]) {
        dmChats[username] = { messages: [], nickname: "", postContext: postText };
      }
      if (dmChats[username].postContext) {
        document.getElementById('dmPostContext').textContent = `From post: "${dmChats[username].postContext}"`;
        document.getElementById('dmPostContext').style.display = 'block';
      } else {
        document.getElementById('dmPostContext').style.display = 'none';
      }
      document.getElementById('nicknameEdit').style.display = 'none';
      renderDMMessages();
    }

    function editNickname() {
      document.getElementById('nicknameEdit').style.display = 'block';
      document.getElementById('dmNickname').value = dmChats[currentDMUser]?.nickname || "";
      document.getElementById('dmNickname').focus();
    }

    function saveNickname() {
      if (currentDMUser && dmChats[currentDMUser]) {
        const nickname = document.getElementById('dmNickname').value.trim();
        dmChats[currentDMUser].nickname = nickname;
        localStorage.setItem('dmChats', JSON.stringify(dmChats));
        document.getElementById('dmUsername').textContent = `@${currentDMUser}${nickname ? ` (${nickname})` : ''}`;
        document.getElementById('nicknameEdit').style.display = 'none';
      }
    }

    function cancelNicknameEdit() {
      document.getElementById('nicknameEdit').style.display = 'none';
    }

    function closeDM() {
      document.getElementById('dmModal').style.display = 'none';
      currentDMUser = null;
    }

    function sendDM() {
      const input = document.getElementById('dmInput');
      const text = input.value.trim();
      if (text && currentDMUser) {
        dmChats[currentDMUser].messages.push({
          text: text,
          fromMe: true,
          timestamp: new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' })
        });
        localStorage.setItem('dmChats', JSON.stringify(dmChats));
        input.value = "";
        renderDMMessages();
        if (Math.random() < 0.6) {
          setTimeout(() => {
            if (dmChats[currentDMUser]) {
              dmChats[currentDMUser].messages.push({
                text: getRandomPhrase(genericReplies),
                fromMe: false,
                timestamp: new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' })
              });
              localStorage.setItem('dmChats', JSON.stringify(dmChats));
              if (currentDMUser) renderDMMessages();
            }
          }, Math.random() * 3000 + 1000);
        }
      }
    }

    function renderDMMessages() {
      const container = document.getElementById('dmMessages');
      const chat = dmChats[currentDMUser];
      if (!chat) return;
      let html = chat.messages.map(msg => {
        const align = msg.fromMe ? 'right' : 'left';
        const bg = msg.fromMe ? 'rgba(0, 240, 255, 0.2)' : 'rgba(255, 255, 255, 0.1)';
        return `
          <div style="text-align: ${align}; margin-bottom: 12px;">
            <div style="display: inline-block; max-width: 70%; background: ${bg}; padding: 10px 14px; border-radius: 12px; text-align: left;">
              <div style="font-size: 0.95rem;">${msg.text}</div>
              <div style="font-size: 0.75rem; color: var(--muted); margin-top: 4px;">${msg.timestamp}</div>
            </div>
          </div>
        `;
      }).join('');
      container.innerHTML = html || '<div style="text-align: center; color: var(--muted); padding: 40px;">No messages yet. Start the conversation!</div>';
      container.scrollTop = container.scrollHeight;
    }

    function renderMessages() {
      const container = document.getElementById('messagesContainer');
      let html = '<div class="panel"><h2 style="margin: 0 0 20px 0;"><i class="fas fa-envelope"></i> Messages</h2>';
      if (dmRequests.length > 0) {
        html += '<h3 style="color: var(--accent1); margin: 16px 0 12px 0;">Message Requests</h3>';
        dmRequests.forEach(req => {
          const username = typeof req === 'string' ? req : req.username;
          const postText = typeof req === 'object' && req.postText ? req.postText : '';
          const intro = typeof req === 'object' && req.intro ? req.intro : 'Hey!';
          const initialMessage = typeof req === 'object' && req.initialMessage ? req.initialMessage : '';
          html += `
            <div class="post" style="margin-bottom: 12px;">
              <div style="display: flex; flex-direction: column; gap: 8px;">
                <div>
                  <span class="username">@${username}</span> wants to message you
                </div>
                <div style="background: rgba(0, 240, 255, 0.1); padding: 10px; border-radius: 8px; border-left: 3px solid var(--accent1);">
                  <strong style="color: var(--accent1);">Their intro:</strong> "${intro}"
                </div>
                ${initialMessage ? `<div style="background: rgba(255, 255, 255, 0.05); padding: 10px; border-radius: 8px; margin-top: 4px;"><strong>First message:</strong> "${initialMessage}"</div>` : ''}
                ${postText ? `<div class="post-context">From: "${postText}"</div>` : ''}
                <div style="display: flex; gap: 8px; margin-top: 8px;">
                  <button onclick="acceptDM('${username.replace(/'/g, "\\'")}', '${postText.replace(/'/g, "\\'")}', '${initialMessage.replace(/'/g, "\\'")}')">Accept</button>
                  <button onclick="rejectDM('${username.replace(/'/g, "\\'")}')">Decline</button>
                </div>
              </div>
            </div>
          `;
        });
      }
      const chatUsers = Object.keys(dmChats);
      if (chatUsers.length > 0) {
        html += '<h3 style="color: var(--accent1); margin: 24px 0 12px 0;">Active Chats</h3>';
        chatUsers.forEach(username => {
          const chat = dmChats[username];
          const lastMsg = chat.messages.length > 0 ? chat.messages[chat.messages.length - 1].text : "No messages";
          html += `
            <div class="post" style="cursor: pointer; margin-bottom: 12px;" onclick="openDM('${username.replace(/'/g, "\\'")}', '${(chat.postContext || '').replace(/'/g, "\\'")}')">
              <div style="display: flex; justify-content: space-between; align-items: center;">
                <div style="flex: 1;">
                  <div>
                    <span class="username">@${username}</span> 
                    ${chat.nickname ? `<span style="color: var(--accent1); font-weight: bold;"> ‚Üí ${chat.nickname}</span>` : ''}
                  </div>
                  ${chat.postContext ? `<div class="post-context" style="margin: 4px 0;">From: "${chat.postContext}"</div>` : ''}
                  <div style="font-size: 0.9rem; color: var(--muted); margin-top: 4px;">${lastMsg.substring(0, 50)}${lastMsg.length > 50 ? '...' : ''}</div>
                </div>
                <span style="color: var(--accent1);">${chat.messages.length} msgs</span>
              </div>
            </div>
          `;
        });
      }
      if (dmRequests.length === 0 && chatUsers.length === 0) {
        html += '<div class="empty">No messages yet. Click "DM" on any post to start a conversation!</div>';
      }
      html += '</div>';
      container.innerHTML = html;
    }

    function acceptDM(username, postText = '', initialMessage = '') {
      dmRequests = dmRequests.filter(r => {
        const u = typeof r === 'string' ? r : r.username;
        return u !== username;
      });
      if (!dmChats[username]) {
        dmChats[username] = { messages: [], nickname: "", postContext: postText };
      }
      if (initialMessage) {
        dmChats[username].messages.push({
          text: initialMessage,
          fromMe: false,
          timestamp: new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' })
        });
      }
      localStorage.setItem('dmRequests', JSON.stringify(dmRequests));
      localStorage.setItem('dmChats', JSON.stringify(dmChats));
      renderMessages();
      openDM(username, postText);
    }

    function rejectDM(username) {
      dmRequests = dmRequests.filter(r => {
        const u = typeof r === 'string' ? r : r.username;
        return u !== username;
      });
      localStorage.setItem('dmRequests', JSON.stringify(dmRequests));
      renderMessages();
    }

    // ===== STATS =====
    function renderStats() {
      const container = document.getElementById('statsContainer');
      const myPosts = posts.filter(p => myPostIds.includes(p.id));
      const myComments = [];
      posts.forEach(p => {
        p.comments.forEach((c, idx) => {
          if (myCommentIds.includes(`${p.id}-${idx}`)) {
            myComments.push(c);
          }
        });
      });
      let totalUpvotes = 0;
      let totalDownvotes = 0;
      myPosts.forEach(p => {
        totalUpvotes += p.upvotes || 0;
        totalDownvotes += p.downvotes || 0;
      });
      myComments.forEach(c => {
        totalUpvotes += c.upvotes || 0;
        totalDownvotes += c.downvotes || 0;
      });
      const status = calculateStatus();
      const overallRatio = getVoteRatio(totalUpvotes, totalDownvotes);
      const myVoteTotal = (settings.myVoteRatio?.up || 0) + (settings.myVoteRatio?.down || 0) + (settings.myVoteRatio?.mid || 0);
      const myVoteRatioStr = myVoteTotal > 0 ? 
        `‚Üë${Math.round(((settings.myVoteRatio?.up || 0) / myVoteTotal) * 100)}% ‚Üì${Math.round(((settings.myVoteRatio?.down || 0) / myVoteTotal) * 100)}% ~${Math.round(((settings.myVoteRatio?.mid || 0) / myVoteTotal) * 100)}%` : 
        'N/A';

      let html = `
        <div class="panel">
          <h2 style="margin: 0 0 20px 0;"><i class="fas fa-chart-bar"></i> Your Statistics</h2>
          <div class="stat-grid">
            <div class="stat-card">
              <div class="stat-label">STATUS</div>
              <div class="stat-value" style="color: ${getStatusColor(status)};">${status}</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">Total Posts</div>
              <div class="stat-value">${myPosts.length}</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">Total Comments</div>
              <div class="stat-value">${myComments.length}</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">Total Upvotes</div>
              <div class="stat-value" style="color: #00ff00;">${totalUpvotes.toFixed(1)}</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">Total Downvotes</div>
              <div class="stat-value" style="color: #ff4444;">${totalDownvotes.toFixed(1)}</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">Vote Ratio</div>
              <div class="stat-value">${overallRatio}</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">My Vote Ratio</div>
              <div class="stat-value" style="font-size: 1.2rem;">${myVoteRatioStr}</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">Saved Posts</div>
              <div class="stat-value">${savedPostIds.length}</div>
            </div>
          </div>
        </div>
      `;
      container.innerHTML = html;
    }

    // ===== REALTIME =====
    document.getElementById('postText').addEventListener('input', () => {
      isTyping = true;
      clearTimeout(typingTimeout);
      typingTimeout = setTimeout(() => { isTyping = false; }, 2000);
    });
    document.getElementById('postText').addEventListener('focus', () => { isTyping = true; });
    document.getElementById('postText').addEventListener('blur', () => {
      setTimeout(() => { isTyping = false; }, 500);
    });

    function autoRefresh() {
      const activeElement = document.activeElement;
      const isInputFocused = activeElement && (activeElement.tagName === 'TEXTAREA' || activeElement.tagName === 'INPUT');
      if (!isTyping && !isInputFocused && currentTab !== 'messages' && currentTab !== 'stats') {
        const scrollPos = window.scrollY;
        posts = JSON.parse(localStorage.getItem('hypomanicPosts')) || [];
        renderPosts();
        window.scrollTo(0, scrollPos);
      }
      if (currentTab === 'messages') {
        renderMessages();
      }
      updateDisplays();
    }

    function autoGeneratePosts() {
      const numPosts = Math.floor(Math.random() * 2) + 1;
      generateAIPosts(numPosts);
    }

    setInterval(() => {
      autoVotePosts();
      autoVoteComments();
    }, Math.random() * 2000 + 1000);

    setInterval(autoRefresh, 3000);
    setInterval(autoGeneratePosts, Math.random() * 5000 + 5000);

    // ===== INIT =====
    if (posts.length === 0) {
      for (let i = 0; i < 6; i++) {
        const fake = getRandomFakeUser();
        posts.push({
          id: Date.now() + i * 1000,
          text: getRandomPhrase(fakePostPhrases),
          username: fake.username,
          city: fake.city,
          timestamp: Date.now() - i * 3600000,
          editedAt: null,
          upvotes: Math.floor(Math.random() * 15),
          downvotes: Math.floor(Math.random() * 4),
          comments: []
        });
      }
      localStorage.setItem('hypomanicPosts', JSON.stringify(posts));
    }

    if (!settings.myVoteRatio) {
      settings.myVoteRatio = { up: 0, down: 0, mid: 0 };
      localStorage.setItem('hypomanicSettings', JSON.stringify(settings));
    }

    renderPosts();
  </script>


</body></html>
